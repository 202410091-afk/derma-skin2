<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai-Derma | Ù…Ø­Ù„Ù„ Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        :root { --primary: #2ecc71; --dark: #2c3e50; --bg: #f5f6fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .app-container { background: white; width: 95%; max-width: 450px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 20px; text-align: center; }
        .header h1 { color: var(--dark); margin: 0; font-size: 22px; }
        #video-container { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; margin: 15px 0; border: 4px solid #f1f3f5; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .btn { border: none; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .btn-scan { background: var(--primary); color: white; }
        .btn-scan:disabled { background: #bdc3c7; }
        
        /* ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #result-list { margin-top: 15px; text-align: right; display: none; }
        .result-item { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-right: 5px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .label-name { font-weight: bold; color: var(--dark); }
        .label-percent { color: var(--primary); font-family: monospace; font-size: 16px; }
        .status-msg { font-size: 13px; color: #7f8c8d; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>ğŸ©º Ai-Derma</h1>
        <div id="status" class="status-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„...</div>
    </div>

    <div id="video-container">
        <video id="webcam" autoplay muted playsinline></video>
    </div>

    <button id="run-btn" class="btn btn-scan" disabled>Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</button>
    
    <div id="result-list">
        </div>

    <button id="share-btn" class="btn" style="background:#3498db; color:white; display:none; font-size:14px;">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸ“¤</button>
</div>

<script src="edge-impulse-standalone.js"></script>
<script src="run-impulse.js"></script>

<script>
    (async () => {
        const video = document.querySelector('#webcam');
        const runBtn = document.querySelector('#run-btn');
        const resultList = document.querySelector('#result-list');
        const status = document.querySelector('#status');
        const shareBtn = document.querySelector('#share-btn');

        try {
            // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            video.srcObject = stream;

            status.textContent = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ÙØ­Øµ âœ…";
            runBtn.disabled = false;
            runBtn.textContent = "Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„";

            runBtn.onclick = async () => {
                runBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
                runBtn.disabled = true;

                // 3. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§
                const features = getFeaturesFromVideo(video);
                const res = classifier.classify(features);

                if (res.results && res.results.length > 0) {
                    displayResults(res.results);
                    shareBtn.style.display = "block";
                }

                runBtn.disabled = false;
                runBtn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ";
            };

        } catch (e) {
            status.textContent = "Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª";
            console.error(e);
        }

        // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙƒÙ‚Ø§Ø¦Ù…Ø© Ù…Ø±ØªØ¨Ø©
        function displayResults(results) {
            resultList.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            resultList.style.display = "block";

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„
            results.sort((a, b) => b.value - a.value);

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ø§ÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ©
                if (item.value > 0.5) div.style.borderRightColor = "#2ecc71";
                
                div.innerHTML = `
                    <span class="label-name">${item.label}</span>
                    <span class="label-percent">${(item.value * 100).toFixed(1)}%</span>
                `;
                resultList.appendChild(div);
            });
        }

        // ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© - Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function getFeaturesFromVideo(v) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ 96x96 Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Edge Impulse
            canvas.width = 96; 
            canvas.height = 96;
            ctx.drawImage(v, 0, 0, 96, 96);
            
            const imageData = ctx.getImageData(0, 0, 96, 96).data;
            let features = [];
            
            for (let i = 0; i < imageData.length; i += 4) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙŠÙ… Red, Green, Blue
                let r = imageData[i];
                let g = imageData[i+1];
                let b = imageData[i+2];
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙŠØªÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¯ÙŠÙ„Ùƒ ÙŠØ³ØªØ®Ø¯Ù… Raw RGB:
                features.push((r << 16) | (g << 8) | b);
            }
            return features;
        }

        shareBtn.onclick = () => {
            let resultText = "ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø¯ Ù…Ù† Ai-Derma:\n";
            document.querySelectorAll('.result-item').forEach(el => {
                resultText += "- " + el.innerText + "\n";
            });
            if (navigator.share) {
                navigator.share({ title: 'Ai-Derma Report', text: resultText });
            } else {
                alert(resultText);
            }
        };
    })();
</script>

</body>
</html>
