<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai-Derma | ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø¯</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f8f9fa; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 20px; transform: scaleX(-1); }
        button { background-color: #007bff; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 18px; width: 100%; font-weight: bold; }
        button:disabled { background-color: #ccc; }
        #results { margin-top: 20px; padding: 15px; background: #f1f3f5; border-radius: 10px; text-align: left; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="project-title">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h2>
    
    <video id="webcam" autoplay muted playsinline></video>
    
    <button id="run-inference" disabled>Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„...</button>
    
    <div id="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
</div>

<script src="edge-impulse-standalone.js"></script>
<script src="run-impulse.js"></script>

<script>
    (async () => {
        const video = document.querySelector('#webcam');
        const btn = document.querySelector('#run-inference');
        const resultsDiv = document.querySelector('#results');
        const title = document.querySelector('#project-title');

        try {
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙ†Ù (Classifier)
            var classifier = new EdgeImpulseClassifier();
            await classifier.init();

            // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
            let project = classifier.getProjectInfo();
            title.textContent = "ğŸ©º Ai-Derma";
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            video.srcObject = stream;

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            btn.disabled = false;
            btn.textContent = "Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙØ­Øµ";

            btn.onclick = async () => {
                btn.disabled = true;
                btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
                
                try {
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Features (Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ù‚Ù…ÙŠØ©)
                    const features = getFeaturesFromVideo(video);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ
                    let res = classifier.classify(features);
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                    resultsDiv.textContent = JSON.stringify(res, null, 4);
                } catch (ex) {
                    resultsDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + ex.message;
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ";
                }
            };
        } catch (err) {
            title.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
            resultsDiv.textContent = "ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù run-impulse.js ÙˆÙ…Ù„Ù wasm.";
        }

        function getFeaturesFromVideo(videoElem) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            // Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù€ Edge Impulse Ù‡ÙŠ 96x96
            canvas.width = 96; 
            canvas.height = 96;
            ctx.drawImage(videoElem, 0, 0, canvas.width, canvas.height);
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let features = [];
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i+1];
                let b = data[i+2];
                features.push((r << 16) | (g << 8) | b);
            }
            return features;
        }
    })();
</script>

</body>
</html>
