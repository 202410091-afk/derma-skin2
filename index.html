<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai-Derma | Ù…Ø­Ù„Ù„ Ø§Ù„Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2ecc71; --dark: #2c3e50; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f5f6fa; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .app-container { background: white; width: 90%; max-width: 400px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 25px; text-align: center; }
        .header h1 { color: var(--dark); margin: 0; font-size: 24px; }
        .header p { color: #7f8c8d; font-size: 14px; margin-top: 5px; }
        #video-container { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 20px; overflow: hidden; margin: 20px 0; border: 5px solid #f1f3f5; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .btn { border: none; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .btn-scan { background: var(--primary); color: white; }
        .btn-scan:hover { background: #27ae60; }
        .btn-scan:disabled { background: #bdc3c7; }
        #result-card { background: #f9f9f9; padding: 15px; border-radius: 15px; display: none; margin-top: 15px; border-right: 5px solid var(--primary); }
        .result-label { display: block; font-size: 20px; font-weight: bold; color: var(--dark); }
        .result-conf { font-size: 14px; color: #7f8c8d; }
        .btn-share { background: #3498db; color: white; font-size: 14px; padding: 10px; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>ğŸ©º Ai-Derma</h1>
        <p id="status">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª...</p>
    </div>

    <div id="video-container">
        <video id="webcam" autoplay muted playsinline></video>
    </div>

    <button id="run-btn" class="btn btn-scan" disabled>Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...</button>
    
    <div id="result-card">
        <span class="result-label" id="label-text">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©...</span>
        <span class="result-conf" id="conf-text">Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„: 0%</span>
    </div>

    <button id="share-btn" class="btn btn-share">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ“¤</button>
</div>

<script src="edge-impulse-standalone.js"></script>
<script src="run-impulse.js"></script>

<script>
    (async () => {
        const video = document.querySelector('#webcam');
        const runBtn = document.querySelector('#run-btn');
        const shareBtn = document.querySelector('#share-btn');
        const resultCard = document.querySelector('#result-card');
        const status = document.querySelector('#status');

        try {
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;

            status.textContent = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ÙØ­Øµ âœ…";
            runBtn.disabled = false;
            runBtn.textContent = "Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙØ­Øµ";

            runBtn.onclick = async () => {
                runBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
                runBtn.disabled = true;

                const features = getFeaturesFromVideo(video);
                const res = classifier.classify(features);

                if (res.results && res.results.length > 0) {
                    const top = res.results[0]; // Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©
                    
                    resultCard.style.display = "block";
                    shareBtn.style.display = "block";
                    document.querySelector('#label-text').textContent = top.label;
                    document.querySelector('#conf-text').textContent = `Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${(top.value * 100).toFixed(1)}%`;
                    
                    // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    resultCard.style.borderRightColor = top.value > 0.7 ? "#2ecc71" : "#f1c40f";
                }

                runBtn.disabled = false;
                runBtn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ";
            };

            shareBtn.onclick = () => {
                const text = `Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ai-Derma: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ù‡ÙŠ (${document.querySelector('#label-text').textContent}) Ø¨Ø¯Ù‚Ø© ${document.querySelector('#conf-text').textContent}`;
                if (navigator.share) {
                    navigator.share({ title: 'Ai-Derma Result', text: text, url: window.location.href });
                } else {
                    alert("Ø§Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©: " + text);
                }
            };

        } catch (e) {
            status.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª";
        }

        function getFeaturesFromVideo(v) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 96; canvas.height = 96;
            ctx.drawImage(v, 0, 0, 96, 96);
            const d = ctx.getImageData(0, 0, 96, 96).data;
            let f = [];
            for (let i = 0; i < d.length; i += 4) {
                f.push((d[i] << 16) | (d[i+1] << 8) | d[i+2]);
            }
            return f;
        }
    })();
</script>

</body>
</html>
